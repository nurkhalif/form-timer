<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121a36;
      --ink: #e8ecff;
      --muted: #9fb0ff;
      --accent: #6ea8fe;
      --danger: #ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--ink); }
    .wrap { max-width: 1100px; margin: 16px auto; padding: 0 16px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: var(--shadow); padding: 16px; margin-bottom: 16px; }
    .digits { font-size: 36px; font-family: monospace; }
    .status { font-size: 14px; color: var(--muted); margin-top: 4px; }
    .bar { height: 10px; border-radius: 999px; background: rgba(255,255,255,.1); overflow: hidden; margin-top: 10px; }
    .fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--danger)); transition: width .25s linear; }
    .iframeWrap { position: relative; overflow: hidden; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); }
    iframe { width: 100%; height: min(78vh, 1200px); border: 0; display: block; background: #0e1630; }
    .overlay { position: absolute; inset: 0; background: rgba(2,6,23,.7); backdrop-filter: blur(3px); color: white; display: none; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    .overlay.show { display: flex; }
    h1 { margin: 0 0 8px; font-size: 22px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">Quiz</h1>
      <div class="digits" id="timeDigits">00:00:00</div>
      <div class="status" id="statusText">Idle</div>
      <div class="bar"><div class="fill" id="fill"></div></div>
    </div>

    <div class="iframeWrap card">
      <iframe id="formFrame"></iframe>
      <div class="overlay" id="overlay">
        <div>
          <h2>‚è∞ Time's up!</h2>
          <p>The form is now locked. Please contact your instructor if needed.</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const formUrl = qs.get('form');
  const mins = Number(qs.get('mins')) || 15;
  const title = qs.get('title') || 'Quiz';

  const frame = document.getElementById('formFrame');
  const overlay = document.getElementById('overlay');
  const timeDigits = document.getElementById('timeDigits');
  const statusText = document.getElementById('statusText');
  const fill = document.getElementById('fill');
  document.getElementById('title').textContent = title;
  document.title = title;

  // Embed URL handling
  if(formUrl){
    const embedUrl = formUrl.includes('embedded=true') ? formUrl : (formUrl.includes('viewform') ? formUrl + (formUrl.includes('?')?'&':'?') + 'embedded=true' : formUrl);
    frame.src = embedUrl;
  } else {
    frame.srcdoc = `<div style="padding:24px; color:#e8ecff; background:#0e1630; min-height:240px">Missing form URL. Please use the admin page to generate a valid link.</div>`;
  }

  let duration = mins*60; // seconds
  let endAt = Date.now() + duration*1000;

  function fmt(sec){
    sec = Math.max(0, Math.floor(sec));
    const h = String(Math.floor(sec/3600)).padStart(2,'0');
    const m = String(Math.floor((sec%3600)/60)).padStart(2,'0');
    const s = String(sec%60).padStart(2,'0');
    return `${h}:${m}:${s}`;
  }

  function tick(){
    const now = Date.now();
    const remaining = Math.max(0, Math.ceil((endAt-now)/1000));
    timeDigits.textContent = fmt(remaining);
    const pct = (1 - remaining/duration)*100;
    fill.style.width = pct+"%";
    if(remaining<=0){
      overlay.classList.add('show');
      statusText.textContent = "Time's up";
      clearInterval(ticker);
    } else if(remaining<=60){
      statusText.textContent = "Less than 1 minute left";
    } else {
      statusText.textContent = "Running";
    }
  }

  tick();
  const ticker = setInterval(tick, 500);
})();
</script>
</body>
</html>
